generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String    @id @default(cuid())
  email                  String    @unique
  passwordHash           String    @map("password_hash")
  name                   String?
  twoFactorEnabled       Boolean   @default(false) @map("two_factor_enabled")
  twoFactorSecret        String?   @map("two_factor_secret")
  twoFactorBackupCodes   String[]  @default([]) @map("two_factor_backup_codes")
  passwordResetToken     String?   @unique @map("password_reset_token")
  passwordResetExpiresAt DateTime? @map("password_reset_expires_at")
  emailVerified          Boolean   @default(false) @map("email_verified")
  emailVerifyToken       String?   @unique @map("email_verify_token")
  failedLoginAttempts    Int       @default(0) @map("failed_login_attempts")
  lastFailedLogin        DateTime? @map("last_failed_login")
  createdAt              DateTime  @default(now()) @map("created_at")
  updatedAt              DateTime  @updatedAt @map("updated_at")

  whatsappNumbers     WhatsappNumber[]
  contactLists        ContactList[]
  campaigns           Campaign[]
  mediaFiles          MediaFile[]
  templates           MessageTemplate[]
  webhooks            Webhook[]
  pipelineStages      PipelineStage[]
  deals               Deal[]
  dealActivities      DealActivity[]
  dealTasks           DealTask[]
  settings            UserSettings?
  onboardingProgress  OnboardingProgress?
  favorites           UserFavorite[]

  @@map("users")
}

model UserSettings {
  id              String   @id @default(cuid())
  userId          String   @unique @map("user_id")
  anthropicApiKey String?  @map("anthropic_api_key")
  locale          String   @default("pt-BR")
  timezone        String   @default("America/Sao_Paulo")
  dateFormat      String   @default("DD/MM/YYYY") @map("date_format")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_settings")
}

// ==================== ONBOARDING ====================

model OnboardingProgress {
  id             String    @id @default(cuid())
  userId         String    @unique @map("user_id")
  currentStep    Int       @default(0) @map("current_step")
  completedSteps String[]  @default([]) @map("completed_steps")
  skipped        Boolean   @default(false)
  completedAt    DateTime? @map("completed_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("onboarding_progress")
}

// ==================== FAVORITES ====================

model UserFavorite {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  type      String   // 'campaign', 'list', 'contact', 'deal'
  entityId  String   @map("entity_id")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type, entityId])
  @@index([userId])
  @@map("user_favorites")
}

model WhatsappNumber {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  phoneNumber String   @map("phone_number")
  name        String?
  sessionData Json?    @map("session_data")
  status      String   @default("disconnected") // connected, disconnected, banned
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  campaignNumbers CampaignNumber[]
  sentMessages    SentMessage[]
  replies         Reply[]

  @@map("whatsapp_numbers")
}

model ContactList {
  id               String   @id @default(cuid())
  userId           String   @map("user_id")
  name             String
  originalFilename String?  @map("original_filename")
  totalContacts    Int      @default(0) @map("total_contacts")
  createdAt        DateTime @default(now()) @map("created_at")

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  contacts  Contact[]
  campaigns Campaign[]

  @@map("contact_lists")
}

model Contact {
  id          String   @id @default(cuid())
  listId      String   @map("list_id")
  phoneNumber String   @map("phone_number")
  name        String?
  extraFields Json?    @map("extra_fields")
  createdAt   DateTime @default(now()) @map("created_at")

  list         ContactList   @relation(fields: [listId], references: [id], onDelete: Cascade)
  sentMessages SentMessage[]
  replies      Reply[]
  deals        Deal[]

  @@index([listId])
  @@index([phoneNumber])
  @@map("contacts")
}

model Campaign {
  id                 String    @id @default(cuid())
  userId             String    @map("user_id")
  listId             String?   @map("list_id")
  name               String
  status             String    @default("draft") // draft, scheduled, running, paused, completed, cancelled
  minIntervalSeconds Int       @default(30) @map("min_interval_seconds")
  maxIntervalSeconds Int       @default(120) @map("max_interval_seconds")
  totalSent          Int       @default(0) @map("total_sent")
  totalDelivered     Int       @default(0) @map("total_delivered")
  totalFailed        Int       @default(0) @map("total_failed")
  totalReplies       Int       @default(0) @map("total_replies")
  scheduledAt        DateTime? @map("scheduled_at") // agendamento
  startedAt          DateTime? @map("started_at")
  completedAt        DateTime? @map("completed_at")
  createdAt          DateTime  @default(now()) @map("created_at")

  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  list            ContactList?      @relation(fields: [listId], references: [id])
  messages        CampaignMessage[]
  campaignNumbers CampaignNumber[]
  sentMessages    SentMessage[]
  replies         Reply[]

  @@map("campaigns")
}

model CampaignMessage {
  id         String   @id @default(cuid())
  campaignId String   @map("campaign_id")
  content    String
  mediaType  String?  @map("media_type") // text, image, audio, video
  mediaUrl   String?  @map("media_url") // URL do arquivo de mídia
  mediaName  String?  @map("media_name") // Nome original do arquivo
  orderIndex Int      @default(0) @map("order_index")
  timesUsed  Int      @default(0) @map("times_used")
  createdAt  DateTime @default(now()) @map("created_at")

  campaign     Campaign      @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  sentMessages SentMessage[]

  @@map("campaign_messages")
}

model MediaFile {
  id           String   @id @default(cuid())
  userId       String   @map("user_id")
  filename     String
  originalName String   @map("original_name")
  mimeType     String   @map("mime_type")
  size         Int
  url          String
  createdAt    DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("media_files")
}

model MessageTemplate {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  name      String
  category  String? // prospecção, follow-up, lembrete, etc
  content   String
  mediaType String?  @map("media_type")
  mediaUrl  String?  @map("media_url")
  mediaName String?  @map("media_name")
  timesUsed Int      @default(0) @map("times_used")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("message_templates")
}

model Webhook {
  id           String    @id @default(cuid())
  userId       String    @map("user_id")
  name         String
  url          String
  secret       String? // Para validação HMAC
  events       String[] // campaign.started, campaign.completed, message.sent, message.failed, reply.received
  isActive     Boolean   @default(true) @map("is_active")
  lastError    String?   @map("last_error")
  lastCalledAt DateTime? @map("last_called_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("webhooks")
}

model CampaignNumber {
  id               String @id @default(cuid())
  campaignId       String @map("campaign_id")
  whatsappNumberId String @map("whatsapp_number_id")
  messagesSent     Int    @default(0) @map("messages_sent")
  repliesReceived  Int    @default(0) @map("replies_received")

  campaign       Campaign       @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  whatsappNumber WhatsappNumber @relation(fields: [whatsappNumberId], references: [id])

  @@map("campaign_numbers")
}

model SentMessage {
  id               String    @id @default(cuid())
  campaignId       String    @map("campaign_id")
  contactId        String    @map("contact_id")
  whatsappNumberId String    @map("whatsapp_number_id")
  messageId        String    @map("message_id")
  status           String    @default("pending") // pending, sent, delivered, failed, replied
  sentAt           DateTime? @map("sent_at")
  deliveredAt      DateTime? @map("delivered_at")
  errorMessage     String?   @map("error_message")
  createdAt        DateTime  @default(now()) @map("created_at")

  campaign       Campaign        @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  contact        Contact         @relation(fields: [contactId], references: [id])
  whatsappNumber WhatsappNumber  @relation(fields: [whatsappNumberId], references: [id])
  message        CampaignMessage @relation(fields: [messageId], references: [id])
  replies        Reply[]

  @@index([campaignId])
  @@index([status])
  @@map("sent_messages")
}

model Reply {
  id               String   @id @default(cuid())
  sentMessageId    String?  @map("sent_message_id")
  campaignId       String   @map("campaign_id")
  contactId        String   @map("contact_id")
  whatsappNumberId String   @map("whatsapp_number_id")
  content          String
  receivedAt       DateTime @default(now()) @map("received_at")

  sentMessage    SentMessage?   @relation(fields: [sentMessageId], references: [id])
  campaign       Campaign       @relation(fields: [campaignId], references: [id])
  contact        Contact        @relation(fields: [contactId], references: [id])
  whatsappNumber WhatsappNumber @relation(fields: [whatsappNumberId], references: [id])

  @@index([campaignId])
  @@map("replies")
}

// ==================== CRM MODELS ====================

model PipelineStage {
  id         String   @id @default(cuid())
  userId     String   @map("user_id")
  name       String
  color      String   @default("#6B7280") // Cor do estágio (hex)
  orderIndex Int      @default(0) @map("order_index")
  isFinal    Boolean  @default(false) @map("is_final") // true para "Ganho" ou "Perdido"
  isWon      Boolean  @default(false) @map("is_won") // true apenas para "Ganho"
  createdAt  DateTime @default(now()) @map("created_at")

  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  deals Deal[]

  @@index([userId])
  @@map("pipeline_stages")
}

model Deal {
  id        String  @id @default(cuid())
  userId    String  @map("user_id")
  contactId String? @map("contact_id")
  stageId   String  @map("stage_id")

  // Informações do Deal
  title       String
  value       Decimal?  @db.Decimal(12, 2) // Valor potencial do negócio
  probability Int       @default(50) // 0-100 (lead scoring)
  company     String? // Nome da empresa
  notes       String? // Observações gerais

  // Datas importantes
  expectedCloseDate DateTime? @map("expected_close_date")
  lastContactAt     DateTime? @map("last_contact_at")
  nextActionAt      DateTime? @map("next_action_at")
  nextActionNote    String?   @map("next_action_note")

  // Metadados de conclusão
  lostReason String?   @map("lost_reason") // Se perdido
  wonAt      DateTime? @map("won_at")
  lostAt     DateTime? @map("lost_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user       User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  contact    Contact?       @relation(fields: [contactId], references: [id])
  stage      PipelineStage  @relation(fields: [stageId], references: [id])
  activities DealActivity[]
  tasks      DealTask[]

  @@index([userId])
  @@index([stageId])
  @@index([contactId])
  @@map("deals")
}

model DealActivity {
  id     String @id @default(cuid())
  dealId String @map("deal_id")
  userId String @map("user_id")

  activityType String  @map("activity_type") // 'note', 'call', 'whatsapp', 'email', 'stage_change', 'task_completed'
  content      String?
  metadata     Json? // { "from_stage": "x", "to_stage": "y", "old_value": 100, "new_value": 200 }

  createdAt DateTime @default(now()) @map("created_at")

  deal Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id])

  @@index([dealId])
  @@map("deal_activities")
}

model DealTask {
  id     String @id @default(cuid())
  dealId String @map("deal_id")
  userId String @map("user_id")

  title       String
  description String?
  dueDate     DateTime? @map("due_date")
  completedAt DateTime? @map("completed_at")
  priority    String    @default("medium") // low, medium, high

  createdAt DateTime @default(now()) @map("created_at")

  deal Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id])

  @@index([dealId])
  @@index([userId])
  @@map("deal_tasks")
}

// ==================== AUDIT LOGS ====================

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?  @map("user_id") // Null for system actions
  action    String // login, logout, password_change, 2fa_enable, 2fa_disable, campaign_start, etc
  resource  String? // Type of resource (campaign, list, contact, etc)
  resourceId String? @map("resource_id") // ID of the affected resource
  details   Json? // Additional details about the action
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

// ==================== LGPD COMPLIANCE ====================

model ContactConsent {
  id          String    @id @default(cuid())
  phoneNumber String    @map("phone_number")
  consentType String    @map("consent_type") // marketing, transactional
  granted     Boolean   @default(false)
  grantedAt   DateTime? @map("granted_at")
  revokedAt   DateTime? @map("revoked_at")
  source      String?   // import, manual, opt-in, api
  ipAddress   String?   @map("ip_address")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@unique([phoneNumber, consentType])
  @@index([phoneNumber])
  @@map("contact_consents")
}

model Blacklist {
  id          String   @id @default(cuid())
  phoneNumber String   @unique @map("phone_number")
  reason      String?  // opt-out, complaint, manual, keyword
  addedBy     String?  @map("added_by") // userId or 'system'
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([phoneNumber])
  @@map("blacklist")
}

// ==================== MULTI-TENANCY ====================

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  plan      String   @default("free") // free, starter, pro, enterprise
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  members OrganizationMember[]

  @@map("organizations")
}

model OrganizationMember {
  id             String   @id @default(cuid())
  organizationId String   @map("organization_id")
  userId         String   @map("user_id")
  role           String   @default("member") // owner, admin, member, viewer
  createdAt      DateTime @default(now()) @map("created_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([userId])
  @@map("organization_members")
}
